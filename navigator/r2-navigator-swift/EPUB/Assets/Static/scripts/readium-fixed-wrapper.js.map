{"version":3,"sources":["webpack://readium-js/./src/index-fixed-wrapper.js"],"names":["readium","FixedPage","iframeId","_pageSize","_viewportSize","_safeAreaInsets","_iframe","document","getElementById","addEventListener","viewport","contentWindow","querySelector","match","regex","properties","exec","content","width","Number","parseFloat","height","layoutPage","_viewport","closest","style","marginTop","top","bottom","marginLeft","left","right","widthRatio","heightRatio","scale","Math","min","link","completion","href","url","page","this","isLoading","loaded","removeEventListener","requestAnimationFrame","src","script","eval","viewportSize","safeAreaInsets","display"],"mappings":"AAQAA,QAAQC,UAAY,SAASC,GAEzB,IAAIC,EAAY,KAEZC,EAAgB,KAEhBC,EAAkB,KAGlBC,EAAUC,SAASC,eAAeN,GACtCI,EAAQG,iBAAiB,QAMzB,WACI,IAAIC,EAAWJ,EAAQK,cAAcJ,SAASK,cAAc,uBAC5D,GAAKF,EAAL,CAMA,IAHA,IAEIG,EAFAC,EAAQ,uBACRC,EAAa,GAEVF,EAAQC,EAAME,KAAKN,EAASO,UAC/BF,EAAWF,EAAM,IAAMA,EAAM,GAEjC,IAAIK,EAAQC,OAAOC,WAAWL,EAAWG,OACrCG,EAASF,OAAOC,WAAWL,EAAWM,QACtCH,GAASG,IACTlB,EAAY,CAAE,MAASe,EAAO,OAAUG,GACxCC,SAlBR,IAAIC,EAAYjB,EAAQkB,QAAQ,aAuBhC,SAASF,IACL,GAAKnB,GAAcC,GAAkBC,EAArC,CAIAC,EAAQmB,MAAMP,MAAQf,EAAUe,MAAQ,KACxCZ,EAAQmB,MAAMJ,OAASlB,EAAUkB,OAAS,KAC1Cf,EAAQmB,MAAMC,UAAarB,EAAgBsB,IAAMtB,EAAgBuB,OAAU,KAC3EtB,EAAQmB,MAAMI,WAAcxB,EAAgByB,KAAOzB,EAAgB0B,MAAS,KAG5E,IAAIC,EAAa5B,EAAcc,MAAQf,EAAUe,MAC7Ce,EAAc7B,EAAciB,OAASlB,EAAUkB,OAC/Ca,EAAQC,KAAKC,IAAIJ,EAAYC,GAGlB1B,SAASK,cAAc,uBAC7BK,QAAU,iBAAmBiB,EAAQ,mBAAqBA,GAGvE,MAAO,CAEH,WAAa,EAGb,KAAQ,KAGR,KAAQ,SAASG,EAAMC,GACnB,GAAKD,EAAKE,MAASF,EAAKG,IAAxB,CAKA,IAAIC,EAAOC,KACXD,EAAKF,KAAOF,EAAKE,KACjBE,EAAKE,WAAY,EAYjBrC,EAAQG,iBAAiB,QAVzB,SAASmC,IACLtC,EAAQuC,oBAAoB,OAAQD,GAGpCtC,EAAQK,cAAcmC,uBAAsB,WACxCL,EAAKE,WAAY,EACbL,GAAcA,UAK1BhC,EAAQyC,IAAMV,EAAKG,SAnBXF,GAAcA,KAuB1B,MAAS,WACAI,KAAKH,OAGVG,KAAKH,KAAO,KACZpC,EAAY,KACZG,EAAQyC,IAAM,gBAIlB,KAAQ,SAASC,GACb,GAAKN,KAAKH,OAAQG,KAAKC,UAGvB,OAAOrC,EAAQK,cAAcsC,KAAKD,IAItC,YAAe,SAASE,EAAcC,GAClC/C,EAAgB8C,EAChB7C,EAAkB8C,EAClB7B,KAIJ,KAAQ,WACJC,EAAUE,MAAM2B,QAAU,SAI9B,KAAQ,WACJ7B,EAAUE,MAAM2B,QAAU","file":"readium-fixed-wrapper.js","sourcesContent":["//\n//  Copyright 2021 Readium Foundation. All rights reserved.\n//  Use of this source code is governed by the BSD-style license\n//  available in the top-level LICENSE file of the project.\n//\n\n// Script used for the wrapper HTML pages of fixed layouts resources.\n\nreadium.FixedPage = function(iframeId) {\n    // Fixed dimensions for the page, extracted from the viewport meta tag.\n    var _pageSize = null;\n    // Available viewport size to fill with the resource.\n    var _viewportSize = null;\n    // Margins that should not overlap the content.\n    var _safeAreaInsets = null;\n\n    // iFrame containing the page.\n    var _iframe = document.getElementById(iframeId);\n    _iframe.addEventListener('load', loadPageSize);\n\n    // Viewport element containing the iFrame.\n    var _viewport = _iframe.closest('.viewport')\n\n    // Parses the page size from the viewport meta tag of the loaded resource.\n    function loadPageSize() {\n        var viewport = _iframe.contentWindow.document.querySelector('meta[name=viewport]');\n        if (!viewport) {\n            return;\n        }\n        var regex = /(\\w+) *= *([^\\s,]+)/g\n        var properties = {};\n        var match;\n        while (match = regex.exec(viewport.content)) {\n            properties[match[1]] = match[2];\n        }\n        var width = Number.parseFloat(properties.width);\n        var height = Number.parseFloat(properties.height);\n        if (width && height) {\n            _pageSize = { 'width': width, 'height': height };\n            layoutPage();\n        }\n    }\n\n    // Layouts the page iframe to center its content and scale it to fill the available viewport.\n    function layoutPage() {\n        if (!_pageSize || !_viewportSize || !_safeAreaInsets) {\n            return;\n        }\n\n        _iframe.style.width = _pageSize.width + 'px';\n        _iframe.style.height = _pageSize.height + 'px';\n        _iframe.style.marginTop = (_safeAreaInsets.top - _safeAreaInsets.bottom) + 'px';\n        _iframe.style.marginLeft = (_safeAreaInsets.left - _safeAreaInsets.right) + 'px';\n\n        // Calculates the zoom scale required to fit the content to the viewport.\n        var widthRatio = _viewportSize.width / _pageSize.width;\n        var heightRatio = _viewportSize.height / _pageSize.height;\n        var scale = Math.min(widthRatio, heightRatio);\n\n        // Sets the viewport of the wrapper page (this page) to scale the iframe.\n        var viewport = document.querySelector('meta[name=viewport]');\n        viewport.content = 'initial-scale=' + scale + ', minimum-scale=' + scale;\n    }\n\n    return {\n        // Returns whether the page is currently loading its contents.\n        'isLoading': false,\n\n        // Href of the resource currently loaded in the page.\n        'href': null,\n\n        // Loads the given link ({href, url}) in the page.\n        'load': function(link, completion) {\n            if (!link.href || !link.url) {\n                if (completion) { completion(); }\n                return;\n            }\n\n            var page = this;\n            page.href = link.href;\n            page.isLoading = true;\n\n            function loaded() {\n                _iframe.removeEventListener('load', loaded);\n\n                // Waiting for the next animation frame seems to do the trick to make sure the page is fully rendered.\n                _iframe.contentWindow.requestAnimationFrame(function() {\n                    page.isLoading = false;\n                    if (completion) { completion(); }\n                });\n            }\n\n            _iframe.addEventListener('load', loaded);\n            _iframe.src = link.url;\n        },\n\n        // Resets the page and empty its contents.\n        'reset': function() {\n            if (!this.href) {\n                return;\n            }\n            this.href = null;\n            _pageSize = null;\n            _iframe.src = 'about:blank';\n        },\n\n        // Evaluates a script in the context of the page.\n        'eval': function(script) {\n            if (!this.href || this.isLoading) {\n                return;\n            }\n            return _iframe.contentWindow.eval(script);\n        },\n\n        // Updates the available viewport to display the resource.\n        'setViewport': function(viewportSize, safeAreaInsets) {\n            _viewportSize = viewportSize;\n            _safeAreaInsets = safeAreaInsets;\n            layoutPage();\n        },\n\n        // Shows the page's viewport.\n        'show': function() {\n            _viewport.style.display = 'block';\n        },\n\n        // Hides the page's viewport.\n        'hide': function() {\n            _viewport.style.display = 'none';\n        }\n    };\n}\n"],"sourceRoot":""}